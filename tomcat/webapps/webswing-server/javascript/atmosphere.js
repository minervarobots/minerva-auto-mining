/*
 * Copyright 2015 Async-IO.org
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

(function(e,t){typeof webswingRequirejs.define=="function"&&webswingRequirejs.define.amd?webswingRequirejs.define(t):typeof exports!="undefined"?module.exports=t():e.atmosphere=t()})(this,function(){var e="2.3.1-javascript",t={},n,r=!1,i=[],s=[],o=0,u=Object.prototype.hasOwnProperty;return t={onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(e){var n,r;return e.onMessage=function(e){r.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){r.onmessage({data:e.responseBody})},e.onOpen=function(e){r.onopen(e)},r={close:function(){n.close()},send:function(e){n.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},n=new t.subscribe(e),r},AtmosphereRequest:function(n){function N(){p=!0,g=!1,d=0,a=null,f=null,l=null,c=null}function C(){_(),N()}function k(e){return e=="debug"?i.logLevel==="debug":e=="info"?i.logLevel==="info"||i.logLevel==="debug":e=="warn"?i.logLevel==="warn"||i.logLevel==="info"||i.logLevel==="debug":e=="error"?i.logLevel==="error"||i.logLevel==="warn"||i.logLevel==="info"||i.logLevel==="debug":!1}function L(e){k("debug")&&t.util.debug(new Date+" Atmosphere: "+e)}function A(e,t){return u.partialMessage===""&&t.transport==="streaming"&&e.responseText.length>t.maxStreamingLength?!0:!1}function O(){if(i.enableProtocol&&!i.disableDisconnect&&!i.firstMessage){var e="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+i.uuid;t.util.each(i.headers,function(n,r){var s=t.util.isFunction(r)?r.call(this,i,i,u):r;s!=null&&(e+="&"+encodeURIComponent(n)+"="+encodeURIComponent(s))});var n=i.url.replace(/([?&])_=[^&]*/,e);n+=n===i.url?(/\?/.test(i.url)?"&":"?")+e:"";var r={connected:!1},s=new t.AtmosphereRequest(r);s.connectTimeout=i.connectTimeout,s.attachHeadersAsQueryString=!1,s.dropHeaders=!0,s.url=n,s.contentType="text/plain",s.transport="polling",s.method="GET",s.data="",s.heartbeat=null,i.enableXDR&&(s.enableXDR=i.enableXDR),s.async=i.closeAsync,pt("",s)}}function M(){L("Closing (AtmosphereRequest._close() called)"),g=!0,i.reconnectId&&(clearTimeout(i.reconnectId),delete i.reconnectId),i.heartbeatTimer&&clearTimeout(i.heartbeatTimer),i.reconnect=!1,u.request=i,u.state="unsubscribe",u.responseBody="",u.status=408,u.partialMessage="",Lt(),O(),_()}function _(){u.partialMessage="",i.id&&clearTimeout(i.id),i.heartbeatTimer&&clearTimeout(i.heartbeatTimer),i.reconnectId&&(clearTimeout(i.reconnectId),delete i.reconnectId),c!=null&&(c.close(),c=null),h!=null&&(h.abort(),h=null),l!=null&&(l.abort(),l=null),a!=null&&(a.canSendMessage&&(L("invoking .close() on WebSocket object"),a.close()),a=null),f!=null&&(f.close(),f=null),D()}function D(){b!=null&&(clearInterval(S),document.cookie=x+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",b.signal("close",{reason:"",heir:g?(b.get("children")||[])[0]:E}),b.close()),w!=null&&w.close()}function P(e){C(),i=t.util.extend(i,e),i.mrequest=i.reconnect,i.reconnect||(i.reconnect=!0)}function H(){return i.webSocketImpl!=null||window.WebSocket||window.MozWebSocket}function B(){var e=t.util.getAbsoluteURL(i.url.toLowerCase()),n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e),r=!(!n||n[1]==window.location.protocol&&n[2]==window.location.hostname&&(n[3]||(n[1]==="http:"?80:443))==(window.location.port||(window.location.protocol==="http:"?80:443)));return window.EventSource&&(!r||!t.util.browser.safari||t.util.browser.vmajor>=7)}function j(){if(i.shared){w=F(i);if(w!=null){k("debug")&&t.util.debug("Storage service available. All communication will be local");if(w.open(i))return}k("debug")&&t.util.debug("No Storage service available."),w=null}i.firstMessage=o==0?!0:!1,i.isOpen=!1,i.ctime=t.util.now(),i.uuid===0&&(i.uuid=o),u.closedByClientTimeout=!1,i.transport!=="websocket"&&i.transport!=="sse"?nt(i):i.transport==="websocket"?H()?V(!1):Y("Websocket is not supported, using request.fallbackTransport ("+i.fallbackTransport+")"):i.transport==="sse"&&(B()?X(!1):Y("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+i.fallbackTransport+")"))}function F(e){function a(e,t){var n,r=e.length;for(n=0;n<r;n++)e[n]===t&&e.splice(n,1);return r!==e.length}function f(n){var r=t.util.parseJSON(n),o=r.data;if(r.target==="c")switch(r.type){case"open":q("opening","local",i);break;case"close":s||(s=!0,o.reason==="aborted"?M():o.heir===E?j():setTimeout(function(){j()},100));break;case"message":xt(o,"messageReceived",200,e.transport);break;case"localMessage":St(o)}}function l(){var e=(new RegExp("(?:^|; )("+encodeURIComponent(o)+")=([^;]*)")).exec(document.cookie);if(e)return t.util.parseJSON(decodeURIComponent(e[2]))}var n,r,s,o="atmosphere-"+e.url,u={storage:function(){function n(e){e.key===o&&e.newValue&&f(e.newValue)}if(!t.util.storage)return;var r=window.localStorage,i=function(e){return t.util.parseJSON(r.getItem(o+"-"+e))},s=function(e,n){r.setItem(o+"-"+e,t.util.stringifyJSON(n))};return{init:function(){return s("children",i("children").concat([E])),t.util.on(window,"storage",n),i("opened")},signal:function(e,n){r.setItem(o,t.util.stringifyJSON({target:"p",type:e,data:n}))},close:function(){var r=i("children");t.util.off(window,"storage",n),r&&a(r,e.id)&&s("children",r)}}},windowref:function(){var e=window.open("",o.replace(/\W/g,""));if(!e||e.closed||!e.callbacks)return;return{init:function(){return e.callbacks.push(f),e.children.push(E),e.opened},signal:function(n,r){!e.closed&&e.fire&&e.fire(t.util.stringifyJSON({target:"p",type:n,data:r}))},close:function(){s||(a(e.callbacks,f),a(e.children,E))}}}};n=l();if(!n||t.util.now()-n.ts>1e3)return;r=u.storage()||u.windowref();if(!r)return;return{open:function(){var i;return S=setInterval(function(){var e=n;n=l(),(!n||e.ts===n.ts)&&f(t.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),i=r.init(),i&&setTimeout(function(){q("opening","local",e)},50),i},send:function(e){r.signal("send",e)},localSend:function(e){r.signal("localSend",t.util.stringifyJSON({id:E,event:e}))},close:function(){g||(clearInterval(S),r.signal("close"),r.close())}}}function I(){function s(e){var n=t.util.parseJSON(e),r=n.data;if(n.target==="p")switch(n.type){case"send":ht(r);break;case"localSend":St(r);break;case"close":M()}}function o(){document.cookie=x+"="+encodeURIComponent(t.util.stringifyJSON({ts:t.util.now()+1,heir:(e.get("children")||[])[0]}))+"; path=/"}var e,n="atmosphere-"+i.url,r={storage:function(){function e(e){e.key===n&&e.newValue&&s(e.newValue)}if(!t.util.storage)return;var r=window.localStorage;return{init:function(){t.util.on(window,"storage",e)},signal:function(e,i){r.setItem(n,t.util.stringifyJSON({target:"c",type:e,data:i}))},get:function(e){return t.util.parseJSON(r.getItem(n+"-"+e))},set:function(e,i){r.setItem(n+"-"+e,t.util.stringifyJSON(i))},close:function(){t.util.off(window,"storage",e),r.removeItem(n),r.removeItem(n+"-opened"),r.removeItem(n+"-children")}}},windowref:function(){var e=n.replace(/\W/g,""),r=document.getElementById(e),i;return r||(r=document.createElement("div"),r.id=e,r.style.display="none",r.innerHTML='<iframe name="'+e+'" />',document.body.appendChild(r)),i=r.firstChild.contentWindow,{init:function(){i.callbacks=[s],i.fire=function(e){var t;for(t=0;t<i.callbacks.length;t++)i.callbacks[t](e)}},signal:function(e,n){!i.closed&&i.fire&&i.fire(t.util.stringifyJSON({target:"c",type:e,data:n}))},get:function(e){return i.closed?null:i[e]},set:function(e,t){i.closed||(i[e]=t)},close:function(){}}}};y=function(n){e.signal("message",n)},e=r.storage()||r.windowref(),e.init(),k("debug")&&t.util.debug("Installed StorageService "+e),e.set("children",[]),e.get("opened")!=null&&!e.get("opened")&&e.set("opened",!1),x=encodeURIComponent(n),o(),S=setInterval(o,1e3),b=e}function q(e,t,n){i.shared&&t!=="local"&&I(),b!=null&&b.set("opened",!0),n.close=function(){M()};if(d>0&&e==="re-connecting")n.isReopen=!0,ot(u);else if(u.error==null){u.request=n;var r=u.state;u.state=e;var s=u.transport;u.transport=t;var o=u.responseBody;Lt(),u.responseBody=o,u.state=r,u.transport=s}}function R(e){e.transport="jsonp";var n=i,r;e!=null&&typeof e!="undefined"&&(n=e),h={open:function(){function o(){n.lastIndex=0,n.openId&&clearTimeout(n.openId),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer),n.reconnect&&d++<n.maxReconnectOnClose?(q("re-connecting",n.transport,n),st(h,n,e.reconnectInterval),n.openId=setTimeout(function(){et(n)},n.reconnectInterval+1e3)):Q(0,"maxReconnectOnClose reached")}function a(){var t=n.url;n.dispatchUrl!=null&&(t+=n.dispatchUrl);var i=n.data;n.attachHeadersAsQueryString&&(t=Z(n),i!==""&&(t+="&X-Atmosphere-Post-Body="+encodeURIComponent(i)),i="");var u=document.head||document.getElementsByTagName("head")[0]||document.documentElement;r=document.createElement("script"),r.src=t+"&jsonpTransport="+s,r.clean=function(){r.clean=r.onerror=r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),++e.scriptCount===2&&(e.scriptCount=1,o())},r.onload=r.onreadystatechange=function(){L("jsonp.onload"),(!r.readyState||/loaded|complete/.test(r.readyState))&&r.clean()},r.onerror=function(){L("jsonp.onerror"),e.scriptCount=1,r.clean()},u.insertBefore(r,u.firstChild)}var s="atmosphere"+ ++E;window[s]=function(r){L("jsonp.window"),e.scriptCount=0;if(n.reconnect&&n.maxRequest===-1||n.requestCount++<n.maxRequest){n.executeCallbackBeforeReconnect||st(h,n,n.pollingInterval);if(r!=null&&typeof r!="string")try{r=r.message}catch(s){}var o=G(r,n,u);o||xt(u.responseBody,"messageReceived",200,n.transport),n.executeCallbackBeforeReconnect&&st(h,n,n.pollingInterval),J(n)}else t.util.log(i.logLevel,["JSONP reconnect maximum try reached "+i.requestCount]),Q(0,"maxRequest reached")},setTimeout(function(){a()},50)},abort:function(){r&&r.clean&&r.clean()}},h.open()}function U(e){return i.webSocketImpl!=null?i.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}function z(){return Z(i,t.util.getAbsoluteURL(i.webSocketUrl||i.url)).replace(/^http/,"ws")}function W(){var e=Z(i);return e}function X(e){u.transport="sse";var n=W();k("debug")&&(t.util.debug("Invoking executeSSE"),t.util.debug("Using URL: "+n));if(e&&!i.reconnect){f!=null&&_();return}try{f=new EventSource(n,{withCredentials:i.withCredentials})}catch(r){Q(0,r),Y("SSE failed. Downgrading to fallback transport and resending");return}i.connectTimeout>0&&(i.id=setTimeout(function(){e||_()},i.connectTimeout)),f.onopen=function(n){L("sse.onopen"),J(i),k("debug")&&t.util.debug("SSE successfully opened"),i.enableProtocol?i.isReopen&&(i.isReopen=!1,q("re-opening",i.transport,i)):e?q("re-opening","sse",i):q("opening","sse",i),e=!0,i.method==="POST"&&(u.state="messageReceived",f.send(i.data))},f.onmessage=function(e){L("sse.onmessage"),J(i);if(!i.enableXDR&&window.location.host&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host){t.util.log(i.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]);return}u.state="messageReceived",u.status=200,e=e.data;var n=G(e,i,u);n||(Lt(),u.responseBody="",u.messages=[])},f.onerror=function(n){L("sse.onerror"),clearTimeout(i.id),i.heartbeatTimer&&clearTimeout(i.heartbeatTimer);if(u.closedByClientTimeout)return;kt(e),_(),g?t.util.log(i.logLevel,["SSE closed normally"]):e?i.reconnect&&u.transport==="sse"&&(d++<i.maxReconnectOnClose?(q("re-connecting",i.transport,i),i.reconnectInterval>0?i.reconnectId=setTimeout(function(){X(!0)},i.reconnectInterval):X(!0),u.responseBody="",u.messages=[]):(t.util.log(i.logLevel,["SSE reconnect maximum try reached "+d]),Q(0,"maxReconnectOnClose reached"))):Y("SSE failed. Downgrading to fallback transport and resending")}}function V(e){u.transport="websocket";var n=z(i.url);k("debug")&&t.util.debug("Invoking executeWebSocket, using URL: "+n);if(e&&!i.reconnect){a!=null&&_();return}a=U(n),i.webSocketBinaryType!=null&&(a.binaryType=i.webSocketBinaryType),i.connectTimeout>0&&(i.id=setTimeout(function(){if(!e){var t={code:1002,reason:"",wasClean:!1};a.onclose(t);try{_()}catch(n){}return}},i.connectTimeout)),a.onopen=function(n){L("websocket.onopen"),J(i),r=!1,k("debug")&&t.util.debug("Websocket successfully opened");var s=e;a!=null&&(a.canSendMessage=!0),i.enableProtocol||(e=!0,s?q("re-opening","websocket",i):q("opening","websocket",i)),a!=null&&i.method==="POST"&&(u.state="messageReceived",a.send(i.data))},a.onmessage=function(t){L("websocket.onmessage"),J(i),i.enableProtocol&&(e=!0),u.state="messageReceived",u.status=200,t=t.data;var n=typeof t=="string";if(n){var r=G(t,i,u);r||(Lt(),u.responseBody="",u.messages=[])}else{t=$(i,t);if(t==="")return;u.responseBody=t,Lt(),u.responseBody=null}},a.onerror=function(e){L("websocket.onerror"),clearTimeout(i.id),i.heartbeatTimer&&clearTimeout(i.heartbeatTimer)},a.onclose=function(n){L("websocket.onclose"),clearTimeout(i.id);if(u.state==="closed")return;var s=n.reason;if(s==="")switch(n.code){case 1e3:s="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:s="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:s="The endpoint is terminating the connection due to a protocol error.";break;case 1003:s="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:s="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:s="Unknown: no status code was provided even though one was expected.";break;case 1006:s="Connection was closed abnormally (that is, with no close frame being sent)."}k("warn")&&t.util.warn("Websocket closed, reason: "+s+" - wasClean: "+n.wasClean);if(u.closedByClientTimeout||i.handleOnlineOffline&&r){i.reconnectId&&(clearTimeout(i.reconnectId),delete i.reconnectId);return}kt(e),u.state="closed",g?t.util.log(i.logLevel,["Websocket closed normally"]):e?i.reconnect&&u.transport==="websocket"&&(_(),d++<i.maxReconnectOnClose?(q("re-connecting",i.transport,i),i.reconnectInterval>0?i.reconnectId=setTimeout(function(){u.responseBody="",u.messages=[],V(!0)},i.reconnectInterval):(u.responseBody="",u.messages=[],V(!0))):(t.util.log(i.logLevel,["Websocket reconnect maximum try reached "+d]),k("warn")&&t.util.warn("Websocket error, reason: "+n.reason),Q(0,"maxReconnectOnClose reached"))):Y("Websocket failed on first connection attempt. Downgrading to "+i.fallbackTransport+" and resending")};var s=navigator.userAgent.toLowerCase(),o=s.indexOf("android")>-1;o&&a.url===undefined&&a.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function $(e,n){var r=n;if(e.transport==="polling")return r;if(e.enableProtocol&&e.firstMessage&&t.util.trim(n).length!==0){var s=e.trackMessageLength?1:0,u=n.split(e.messageDelimiter);if(u.length<=s+1)return r;e.firstMessage=!1,e.uuid=t.util.trim(u[s]),u.length<=s+2&&t.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),v=parseInt(t.util.trim(u[s+1]),10),m=u[s+2],e.transport!=="long-polling"&&et(e),o=e.uuid,r="",s=e.trackMessageLength?4:3;if(u.length>s+1)for(var a=s;a<u.length;a++)r+=u[a],a+1!==u.length&&(r+=e.messageDelimiter);e.ackInterval!==0&&setTimeout(function(){ht("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10?t.util.log(i.logLevel,["Receiving unexpected data from IE"]):et(e);return r}function J(e){clearTimeout(e.id),e.timeout>0&&e.transport!=="polling"&&(e.id=setTimeout(function(){K(e),O(),_()},e.timeout))}function K(e){u.closedByClientTimeout=!0,u.state="closedByClient",u.responseBody="",u.status=408,u.messages=[],Lt()}function Q(e,t){_(),clearTimeout(i.id),u.state="error",u.reasonPhrase=t,u.responseBody="",u.status=e,u.messages=[],Lt()}function G(e,t,n){e=$(t,e);if(e.length===0)return!0;n.responseBody=e;if(t.trackMessageLength){e=n.partialMessage+e;var r=[],i=e.indexOf(t.messageDelimiter);if(i!=-1){while(i!==-1){var s=e.substring(0,i),o=+s;if(isNaN(o))throw new Error('message length "'+s+'" is not a number');i+=t.messageDelimiter.length,i+o>e.length?i=-1:(r.push(e.substring(i,i+o)),e=e.substring(i+o,e.length),i=e.indexOf(t.messageDelimiter))}return n.partialMessage=e,r.length!==0?(n.responseBody=r.join(t.messageDelimiter),n.messages=r,!1):(n.responseBody="",n.messages=[],!0)}}return n.responseBody=e,n.messages=[e],!1}function Y(e){t.util.log(i.logLevel,[e]),typeof i.onTransportFailure!="undefined"?i.onTransportFailure(e,i):typeof t.util.onTransportFailure!="undefined"&&t.util.onTransportFailure(e,i),i.transport=i.fallbackTransport;var n=i.connectTimeout===-1?0:i.connectTimeout;i.reconnect&&i.transport!=="none"||i.transport==null?(i.method=i.fallbackMethod,u.transport=i.fallbackTransport,i.fallbackTransport="none",n>0?i.reconnectId=setTimeout(function(){j()},n):j()):Q(500,"Unable to reconnect with fallback transport")}function Z(n,r){var s=i;return n!=null&&typeof n!="undefined"&&(s=n),r==null&&(r=s.url),s.attachHeadersAsQueryString?r.indexOf("X-Atmosphere-Framework")!==-1?r:(r+=r.indexOf("?")!==-1?"&":"?",r+="X-Atmosphere-tracking-id="+s.uuid,r+="&X-Atmosphere-Framework="+e,r+="&X-Atmosphere-Transport="+s.transport,s.trackMessageLength&&(r+="&X-Atmosphere-TrackMessageSize=true"),s.heartbeat!==null&&s.heartbeat.server!==null&&(r+="&X-Heartbeat-Server="+s.heartbeat.server),s.contentType!==""&&(r+="&Content-Type="+(s.transport==="websocket"?s.contentType:encodeURIComponent(s.contentType))),s.enableProtocol&&(r+="&X-atmo-protocol=true"),t.util.each(s.headers,function(e,i){var o=t.util.isFunction(i)?i.call(this,s,n,u):i;o!=null&&(r+="&"+encodeURIComponent(e)+"="+encodeURIComponent(o))}),r):r}function et(e){if(!e.isOpen)e.isOpen=!0,q("opening",e.transport,e);else if(e.isReopen)e.isReopen=!1,q("re-opening",e.transport,e);else{if(u.state!=="messageReceived"||e.transport!=="jsonp"&&e.transport!=="long-polling")return;ut(u)}tt(e)}function tt(e){e.heartbeatTimer!=null&&clearTimeout(e.heartbeatTimer);if(!isNaN(v)&&v>0){var n=function(){k("debug")&&t.util.debug("Sending heartbeat"),ht(m),e.heartbeatTimer=setTimeout(n,v)};e.heartbeatTimer=setTimeout(n,v)}}function nt(e){var n=i;if(e!=null||typeof e!="undefined")n=e;n.lastIndex=0,n.readyState=0;if(n.transport==="jsonp"||n.enableXDR&&t.util.checkCORSSupport()){R(n);return}if(t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10){if(n.transport==="streaming"){n.enableXDR&&window.XDomainRequest?at(n):lt(n);return}if(n.enableXDR&&window.XDomainRequest){at(n);return}}var r=function(t){n.lastIndex=0,d++;if(t||n.reconnect&&d<=n.maxReconnectOnClose){var r=t?0:e.reconnectInterval;u.ffTryingReconnect=!0,q("re-connecting",e.transport,e),st(a,n,r)}else Q(0,"maxReconnectOnClose reached")},s=function(e){t._beforeUnloadState?(t.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){r(e)},5e3)):r(e)},o=function(){u.errorHandled=!0,_(),s(!1)};if(n.force||n.reconnect&&(n.maxRequest===-1||n.requestCount++<n.maxRequest)){n.force=!1;var a=t.util.xhr();a.hasData=!1,it(a,n,!0),n.suspend&&(l=a),n.transport!=="polling"&&(u.transport=n.transport,a.onabort=function(){L("ajaxrequest.onabort"),kt(!0)},a.onerror=function(){L("ajaxrequest.onerror"),u.error=!0,u.ffTryingReconnect=!0;try{u.status=XMLHttpRequest.status}catch(e){u.status=500}u.status||(u.status=500),u.errorHandled||(_(),s(!1))}),a.onreadystatechange=function(){L("ajaxRequest.onreadystatechange, new state: "+a.readyState);if(g){L("onreadystatechange has been ignored due to _abortingConnection flag");return}u.error=null;var r=!1,f=!1;if(n.transport==="streaming"&&n.readyState>2&&a.readyState===4){_(),s(!1);return}n.readyState=a.readyState,n.transport==="streaming"&&a.readyState>=3?f=!0:n.transport==="long-polling"&&a.readyState===4&&(f=!0),J(i);if(n.transport!=="polling"){var l=200;a.readyState===4&&(l=a.status>1e3?0:a.status);if(!n.reconnectOnServerError&&l>=300&&l<600){Q(l,a.statusText);return}if(l>=300||l===0){o();return}(!n.enableProtocol||!e.firstMessage)&&a.readyState===2&&(t.util.browser.mozilla&&u.ffTryingReconnect?(u.ffTryingReconnect=!1,setTimeout(function(){u.ffTryingReconnect||et(n)},500)):et(n))}else a.readyState===4&&(f=!0);if(f){var c=a.responseText;u.errorHandled=!1;if(n.transport==="long-polling"&&t.util.trim(c).length===0){a.hasData?a.hasData=!1:s(!0);return}a.hasData=!0,Tt(a,i);if(n.transport==="streaming")if(!t.util.browser.opera){var h=c.substring(n.lastIndex,c.length);r=G(h,n,u),n.lastIndex=c.length;if(r)return}else t.util.iterate(function(){if(u.status!==500&&a.responseText.length>n.lastIndex){try{u.status=a.status,u.headers=t.util.parseHeaders(a.getAllResponseHeaders()),Tt(a,i)}catch(e){u.status=404}J(i),u.state="messageReceived";var s=a.responseText.substring(n.lastIndex);n.lastIndex=a.responseText.length,r=G(s,n,u),r||Lt();if(A(a,n)){rt(a,n);return}}else if(u.status>400)return n.lastIndex=a.responseText.length,!1},0);else r=G(c,n,u);var p=A(a,n);try{u.status=a.status,u.headers=t.util.parseHeaders(a.getAllResponseHeaders()),Tt(a,n)}catch(d){u.status=404}n.suspend?u.state=u.status===0?"closed":"messageReceived":u.state="messagePublished";var v=!p&&e.transport!=="streaming"&&e.transport!=="polling";v&&!n.executeCallbackBeforeReconnect&&st(a,n,n.pollingInterval),u.responseBody.length!==0&&!r&&Lt(),v&&n.executeCallbackBeforeReconnect&&st(a,n,n.pollingInterval),p&&rt(a,n)}};try{a.send(n.data),p=!0}catch(f){t.util.log(n.logLevel,["Unable to connect to "+n.url]),Q(0,f)}}else n.logLevel==="debug"&&t.util.log(n.logLevel,["Max re-connection reached."]),Q(0,"maxRequest reached")}function rt(e,t){u.messages=[],t.isReopen=!0,M(),g=!1,st(e,t,500)}function it(n,r,s){var o=r.url;r.dispatchUrl!=null&&r.method==="POST"&&(o+=r.dispatchUrl),o=Z(r,o),o=t.util.prepareURL(o),s&&(n.open(r.method,o,r.async),r.connectTimeout>0&&(r.id=setTimeout(function(){r.requestCount===0&&(_(),xt("Connect timeout","closed",200,r.transport))},r.connectTimeout))),i.withCredentials&&i.transport!=="websocket"&&"withCredentials"in n&&(n.withCredentials=!0),i.dropHeaders||(n.setRequestHeader("X-Atmosphere-Framework",e),n.setRequestHeader("X-Atmosphere-Transport",r.transport),r.heartbeat!==null&&r.heartbeat.server!==null&&n.setRequestHeader("X-Heartbeat-Server",n.heartbeat.server),r.trackMessageLength&&n.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),n.setRequestHeader("X-Atmosphere-tracking-id",r.uuid),t.util.each(r.headers,function(e,i){var o=t.util.isFunction(i)?i.call(this,n,r,s,u):i;o!=null&&n.setRequestHeader(e,o)})),r.contentType!==""&&n.setRequestHeader("Content-Type",r.contentType)}function st(e,t,n){if(u.closedByClientTimeout)return;if(t.reconnect||t.suspend&&p){var r=0;e&&e.readyState>1&&(r=e.status>1e3?0:e.status),u.status=r===0?204:r,u.reason=r===0?"Server resumed the connection or down.":"OK",clearTimeout(t.id),t.reconnectId&&(clearTimeout(t.reconnectId),delete t.reconnectId),n>0?i.reconnectId=setTimeout(function(){nt(t)},n):nt(t)}}function ot(e){e.state="re-connecting",Nt(e)}function ut(e){e.state="openAfterResume",Nt(e),e.state="messageReceived"}function at(e){e.transport!=="polling"?(c=ft(e),c.open()):ft(e).open()}function ft(e){var n=i;e!=null&&typeof e!="undefined"&&(n=e);var r=n.transport,s=0,o=new window.XDomainRequest,a=function(){n.transport==="long-polling"&&n.reconnect&&(n.maxRequest===-1||n.requestCount++<n.maxRequest)&&(o.status=200,at(n))},f=n.rewriteURL||function(e){var t=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(t&&t[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+t[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+t[2]+"&").replace(/&$/,"")}return e};o.onprogress=function(){l(o)},o.onerror=function(){n.transport!=="polling"&&(_(),d++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){q("re-connecting",e.transport,e),at(n)},n.reconnectInterval):(q("re-connecting",e.transport,e),at(n)):Q(0,"maxReconnectOnClose reached"))},o.onload=function(){};var l=function(e){clearTimeout(n.id);var i=e.responseText;i=i.substring(s),s+=i.length;if(r!=="polling"){J(n);var o=G(i,n,u);if(r==="long-polling"&&t.util.trim(i).length===0)return;n.executeCallbackBeforeReconnect&&a(),o||xt(u.responseBody,"messageReceived",200,r),n.executeCallbackBeforeReconnect||a()}};return{open:function(){var e=n.url;n.dispatchUrl!=null&&(e+=n.dispatchUrl),e=Z(n,e),o.open(n.method,f(e)),n.method==="GET"?o.send():o.send(n.data),n.connectTimeout>0&&(n.id=setTimeout(function(){n.requestCount===0&&(_(),xt("Connect timeout","closed",200,n.transport))},n.connectTimeout))},close:function(){o.abort()}}}function lt(e){c=ct(e),c.open()}function ct(e){var n=i;e!=null&&typeof e!="undefined"&&(n=e);var r,s=new window.ActiveXObject("htmlfile");s.open(),s.close();var o=n.url;return n.dispatchUrl!=null&&(o+=n.dispatchUrl),n.transport!=="polling"&&(u.transport=n.transport),{open:function(){var e=s.createElement("iframe");o=Z(n),n.data!==""&&(o+="&X-Atmosphere-Post-Body="+encodeURIComponent(n.data)),o=t.util.prepareURL(o),e.src=o,s.body.appendChild(e);var a=e.contentDocument||e.contentWindow.document;r=t.util.iterate(function(){try{if(!a.firstChild)return;var e=a.body?a.body.lastChild:a,o=function(){var t=e.cloneNode(!0);t.appendChild(a.createTextNode("."));var n=t.innerText;return n=n.substring(0,n.length-1),n};if(!a.body||!a.body.firstChild||a.body.firstChild.nodeName.toLowerCase()!=="pre"){var f=a.head||a.getElementsByTagName("head")[0]||a.documentElement||a,l=a.createElement("script");l.text="document.write('<plaintext>')",f.insertBefore(l,f.firstChild),f.removeChild(l),e=a.body.lastChild}return n.closed&&(n.isReopen=!0),r=t.util.iterate(function(){var t=o();if(t.length>n.lastIndex){J(i),u.status=200,u.error=null,e.innerText="";var r=G(t,n,u);if(r)return"";xt(u.responseBody,"messageReceived",200,n.transport)}n.lastIndex=0;if(a.readyState==="complete")return kt(!0),q("re-connecting",n.transport,n),n.reconnectInterval>0?n.reconnectId=setTimeout(function(){lt(n)},n.reconnectInterval):lt(n),!1},null),!1}catch(c){return u.error=!0,q("re-connecting",n.transport,n),d++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){lt(n)},n.reconnectInterval):lt(n):Q(0,"maxReconnectOnClose reached"),s.execCommand("Stop"),s.close(),!1}})},close:function(){r&&r(),s.execCommand("Stop"),kt(!0)}}}function ht(e){w!=null?dt(e):l!=null||f!=null?mt(e):c!=null?gt(e):h!=null?yt(e):a!=null?Et(e):(Q(0,"No suspended connection available"),t.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function pt(e,t){t||(t=wt(e)),t.transport="polling",t.method="GET",t.withCredentials=!1,t.reconnect=!1,t.force=!0,t.suspend=!1,t.timeout=1e3,nt(t)}function dt(e){w.send(e)}function vt(e){if(e.length===0)return;try{w?w.localSend(e):b&&b.signal("localMessage",t.util.stringifyJSON({id:E,event:e}))}catch(n){t.util.error(n)}}function mt(e){var t=wt(e);nt(t)}function gt(e){if(i.enableXDR&&t.util.checkCORSSupport()){var n=wt(e);n.reconnect=!1,R(n)}else mt(e)}function yt(e){mt(e)}function bt(e){var t=e;return typeof t=="object"&&(t=e.data),t}function wt(e){var n=bt(e),r={connected:!1,timeout:6e4,method:"POST",url:i.url,contentType:i.contentType,headers:i.headers,reconnect:!0,callback:null,data:n,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:i.withCredentials,async:i.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:i.enableXDR,uuid:i.uuid,dispatchUrl:i.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:i.trackMessageLength,maxReconnectOnClose:i.maxReconnectOnClose,heartbeatTimer:i.heartbeatTimer,heartbeat:i.heartbeat};return typeof e=="object"&&(r=t.util.extend(r,e)),r}function Et(e){var n=t.util.isBinary(e)?e:bt(e),r;try{i.dispatchUrl!=null?r=i.webSocketPathDelimiter+i.dispatchUrl+i.webSocketPathDelimiter+n:r=n;if(!a.canSendMessage){t.util.error("WebSocket not connected.");return}a.send(r)}catch(s){a.onclose=function(e){},_(),Y("Websocket failed. Downgrading to "+i.fallbackTransport+" and resending "+e),mt(e)}}function St(e){var n=t.util.parseJSON(e);n.id!==E&&(typeof i.onLocalMessage!="undefined"?i.onLocalMessage(n.event):typeof t.util.onLocalMessage!="undefined"&&t.util.onLocalMessage(n.event))}function xt(e,t,n,r){u.responseBody=e,u.transport=r,u.status=n,u.state=t,Lt()}function Tt(e,t){if(!t.readResponsesHeaders)t.enableProtocol||(t.uuid=E);else try{var n=e.getResponseHeader("X-Atmosphere-tracking-id");n&&n!=null&&(t.uuid=n.split(" ").pop())}catch(r){}}function Nt(e){Ct(e,i),Ct(e,t.util)}function Ct(e,t){switch(e.state){case"messageReceived":L("Firing onMessage"),d=0,typeof t.onMessage!="undefined"&&t.onMessage(e),typeof t.onmessage!="undefined"&&t.onmessage(e);break;case"error":var n=typeof e.reasonPhrase!="undefined"?e.reasonPhrase:"n/a";L("Firing onError, reasonPhrase: "+n),typeof t.onError!="undefined"&&t.onError(e),typeof t.onerror!="undefined"&&t.onerror(e);break;case"opening":delete i.closed,L("Firing onOpen"),typeof t.onOpen!="undefined"&&t.onOpen(e),typeof t.onopen!="undefined"&&t.onopen(e);break;case"messagePublished":L("Firing messagePublished"),typeof t.onMessagePublished!="undefined"&&t.onMessagePublished(e);break;case"re-connecting":L("Firing onReconnect"),typeof t.onReconnect!="undefined"&&t.onReconnect(i,e);break;case"closedByClient":L("Firing closedByClient"),typeof t.onClientTimeout!="undefined"&&t.onClientTimeout(i);break;case"re-opening":delete i.closed,L("Firing onReopen"),typeof t.onReopen!="undefined"&&t.onReopen(i,e);break;case"fail-to-reconnect":L("Firing onFailureToReconnect"),typeof t.onFailureToReconnect!="undefined"&&t.onFailureToReconnect(i,e);break;case"unsubscribe":case"closed":var r=typeof i.closed!="undefined"?i.closed:!1;r?L("Request already closed, not firing onClose ("+e.state+" case)"):(L("Firing onClose ("+e.state+" case)"),typeof t.onClose!="undefined"&&t.onClose(e),typeof t.onclose!="undefined"&&t.onclose(e)),i.closed=!0;break;case"openAfterResume":typeof t.onOpenAfterResume!="undefined"&&t.onOpenAfterResume(i)}}function kt(e){u.state!=="closed"&&(u.state="closed",u.responseBody="",u.messages=[],u.status=e?200:501,Lt())}function Lt(){var e=function(e,t){t(u)};w==null&&y!=null&&y(u.responseBody),i.reconnect=i.mrequest;var n=typeof u.responseBody=="string",r=n&&i.trackMessageLength?u.messages.length>0?u.messages:[""]:new Array(u.responseBody);for(var o=0;o<r.length;o++){if(r.length>1&&r[o].length===0)continue;u.responseBody=n?t.util.trim(r[o]):r[o],w==null&&y!=null&&y(u.responseBody);if((u.responseBody.length===0||n&&m===u.responseBody)&&u.state==="messageReceived")continue;Nt(u);if(s.length>0){k("debug")&&t.util.debug("Invoking "+s.length+" global callbacks: "+u.state);try{t.util.each(s,e)}catch(a){t.util.log(i.logLevel,["Callback exception"+a])}}if(typeof i.callback=="function"){k("debug")&&t.util.debug("Invoking request callbacks");try{i.callback(u)}catch(a){t.util.log(i.logLevel,["Callback exception"+a])}}}}var i={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,disableDisconnect:!1,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,handleOnlineOffline:!0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,t){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},u={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},a=null,f=null,l=null,c=null,h=null,p=!0,d=0,v=0,m="X",g=!1,y=null,b,w=null,E=t.util.now(),S,x,T=!1;P(n),this.subscribe=function(e){P(e),j()},this.execute=function(){j()},this.close=function(){M()},this.disconnect=function(){O()},this.getUrl=function(){return i.url},this.push=function(e,t){if(t!=null){var n=i.dispatchUrl;i.dispatchUrl=t,ht(e),i.dispatchUrl=n}else ht(e)},this.getUUID=function(){return i.uuid},this.pushLocal=function(e){vt(e)},this.enableProtocol=function(e){return i.enableProtocol},this.init=function(){N()},this.request=i,this.response=u}},t.subscribe=function(e,n,r){typeof n=="function"&&t.addCallback(n),typeof e!="string"?r=e:r.url=e,o=typeof r!="undefined"&&typeof r.uuid!="undefined"?r.uuid:0;var s=new t.AtmosphereRequest(r);return s.execute(),i[i.length]=s,s},t.unsubscribe=function(){if(i.length>0){var e=[].concat(i);for(var t=0;t<e.length;t++){var n=e[t];n.close(),clearTimeout(n.response.request.id),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer)}}i=[],s=[]},t.unsubscribeUrl=function(e){var t=-1;if(i.length>0)for(var n=0;n<i.length;n++){var r=i[n];if(r.getUrl()===e){r.close(),clearTimeout(r.response.request.id),r.heartbeatTimer&&clearTimeout(r.heartbeatTimer),t=n;break}}t>=0&&i.splice(t,1)},t.addCallback=function(e){t.util.inArray(e,s)===-1&&s.push(e)},t.removeCallback=function(e){var n=t.util.inArray(e,s);n!==-1&&s.splice(n,1)},t.util={browser:{},parseHeaders:function(e){var t,n=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,r={};while(t=n.exec(e))r[t[1]]=t[2];return r},now:function(){return(new Date).getTime()},isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"},inArray:function(e,t){if(!Array.prototype.indexOf){var n=t.length;for(var r=0;r<n;++r)if(t[r]===e)return r;return-1}return t.indexOf(e)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return Object.prototype.toString.call(e)==="[object Function]"},getAbsoluteURL:function(e){if(typeof document.createElement=="undefined")return e;var t=document.createElement("div");return t.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(t.firstChild.href))},prepareURL:function(e){var n=t.util.now(),r=e.replace(/([?&])_=[^&]*/,"$1_="+n);return r+(r===e?(/\?/.test(e)?"&":"?")+"_="+n:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){function i(e,n){n=t.util.isFunction(n)?n():n==null?"":n,r.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}function s(e,n){var r;if(t.util.isArray(n))t.util.each(n,function(t,n){/\[\]$/.test(e)?i(e,n):s(e+"["+(typeof n=="object"?t:"")+"]",n)});else if(Object.prototype.toString.call(n)==="[object Object]")for(r in n)s(e+"["+r+"]",n[r]);else i(e,n)}var n,r=[];for(n in e)s(n,e[n]);return r.join("&").replace(/%20/g,"+")},storage:function(){try{return!!window.localStorage&&!!window.StorageEvent}catch(e){return!1}},iterate:function(e,t){var n;return t=t||0,function r(){n=setTimeout(function(){if(e()===!1)return;r()},t)}(),function(){clearTimeout(n)}},each:function(e,n,r){if(!e)return;var i,s=0,o=e.length,u=t.util.isArray(e);if(r)if(u)for(;s<o;s++){i=n.apply(e[s],r);if(i===!1)break}else for(s in e){i=n.apply(e[s],r);if(i===!1)break}else if(u)for(;s<o;s++){i=n.call(e[s],s,e[s]);if(i===!1)break}else for(s in e){i=n.call(e[s],s,e[s]);if(i===!1)break}return e},extend:function(e){var t,n,r;for(t=1;t<arguments.length;t++)if((n=arguments[t])!=null)for(r in n)e[r]=n[r];return e},on:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},off:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},log:function(e,t){if(window.console){var n=window.console[e];typeof n=="function"&&n.apply(window.console,t)}},warn:function(){t.util.log("warn",arguments)},info:function(){t.util.log("info",arguments)},debug:function(){t.util.log("debug",arguments)},error:function(){t.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):(new Function("return "+e))():null},stringifyJSON:function(e){function r(e){return'"'+e.replace(t,function(e){var t=n[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function i(e){return e<10?"0"+e:e}var t=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function s(e,t){var n,o,a,l,c=t[e],h=typeof c;c&&typeof c=="object"&&typeof c.toJSON=="function"&&(c=c.toJSON(e),h=typeof c);switch(h){case"string":return r(c);case"number":return isFinite(c)?String(c):"null";case"boolean":return String(c);case"object":if(!c)return"null";switch(Object.prototype.toString.call(c)){case"[object Date]":return isFinite(c.valueOf())?'"'+c.getUTCFullYear()+"-"+i(c.getUTCMonth()+1)+"-"+i(c.getUTCDate())+"T"+i(c.getUTCHours())+":"+i(c.getUTCMinutes())+":"+i(c.getUTCSeconds())+"Z"+'"':"null";case"[object Array]":a=c.length,l=[];for(n=0;n<a;n++)l.push(s(n,c)||"null");return"["+l.join(",")+"]";default:l=[];for(n in c)u.call(c,n)&&(o=s(n,c),o&&l.push(r(n)+":"+o));return"{"+l.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(t.util.browser.msie&&!window.XDomainRequest&&+t.util.browser.version.split(".")[0]<11)return!0;if(t.util.browser.opera&&+t.util.browser.version.split(".")<12)return!0;if(t.util.trim(navigator.userAgent).slice(0,16)==="KreaTVWebKit/531")return!0;if(t.util.trim(navigator.userAgent).slice(-7).toLowerCase()==="kreatel")return!0;var e=navigator.userAgent.toLowerCase(),n=e.match(/.+android ([0-9]{1,2})/i),r=parseInt(n&&n[0]||-1,10);return!isNaN(r)&&r>-1&&r<3?!0:!1}},n=t.util.now(),function(){var e=navigator.userAgent.toLowerCase(),n=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];n[2]==="safari"&&(n[2]=n[1],n[1]="safari"),t.util.browser[n[1]||""]=!0,t.util.browser.version=n[2]||"0",t.util.browser.vmajor=t.util.browser.version.split(".")[0],t.util.browser.trident&&(t.util.browser.msie=!0);if(t.util.browser.msie||t.util.browser.mozilla&&+t.util.browser.version.split(".")[0]===1)t.util.storage=!1}(),t.util.on(window,"unload",function(e){t.util.debug(new Date+" Atmosphere: "+"unload event"),t.unsubscribe()}),t.util.on(window,"beforeunload",function(e){t.util.debug(new Date+" Atmosphere: "+"beforeunload event"),t._beforeUnloadState=!0,setTimeout(function(){t.util.debug(new Date+" Atmosphere: "+"beforeunload event timeout reached. Reset _beforeUnloadState flag"),t._beforeUnloadState=!1},5e3)}),t.util.on(window,"keypress",function(e){(e.charCode===27||e.keyCode===27)&&e.preventDefault&&e.preventDefault()}),t.util.on(window,"offline",function(){t.util.debug(new Date+" Atmosphere: offline event"),r=!0;if(i.length>0){var e=[].concat(i);for(var n=0;n<e.length;n++){var s=e[n];s.request.handleOnlineOffline&&(s.close(),clearTimeout(s.response.request.id),s.heartbeatTimer&&clearTimeout(s.heartbeatTimer))}}}),t.util.on(window,"online",function(){t.util.debug(new Date+" Atmosphere: online event");if(i.length>0)for(var e=0;e<i.length;e++)i[e].request.handleOnlineOffline&&(i[e].init(),i[e].execute());r=!1}),t});
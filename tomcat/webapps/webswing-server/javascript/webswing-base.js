webswingRequirejs.define(["webswing-dd","webswing-util"],function(t,n){return function(){function h(e,t,n){n===!0&&i.disposeIdentity(),d(i.getUser()+i.getIdentity()+e,e,t,!1)}function p(e,t){d(e,t,null,!0)}function d(e,t,n,r){i.registerInput(),i.registerTouch(),window.addEventListener("beforeunload",v),g(),i.cfg.clientId=e,i.cfg.appName=t,i.cfg.canPaint=!0,i.cfg.hasControl=!r,i.cfg.mirrorMode=r,i.cfg.applet=n!=null?n:i.cfg.applet,N(),r&&E(),i.showDialog(i.startingDialog)}function v(e){C()}function m(){i.hideDialog(),i.cfg.canPaint=!0,N(),E(),S()}function g(){i.cfg.clientId="",i.cfg.viewId=n.GUID(),i.cfg.appName=null,i.cfg.hasControl=!1,i.cfg.mirrorMode=!1,i.cfg.canPaint=!1,clearInterval(s),clearInterval(o),clearInterval(u),s=setInterval(i.sendInput,100),o=setInterval(b,1e4),u=setInterval(w,1e5),l={},c.dispose(),c=new t({})}function y(e){i.sendInput({event:{type:e}})}function b(){y("hb")}function w(){i.login(function(){},function(){})}function E(){y("repaint")}function S(){y("paintAck")}function x(){i.cfg.hasControl&&y("killSwing")}function T(){i.cfg.mirrorMode||y("unload")}function N(){i.sendInput(j(i.getCanvas()))}function C(){clearInterval(s),clearInterval(o),T(),i.sendInput(),g(),i.disposeInput(),i.disposeTouch(),window.removeEventListener("beforeunload",v),c.dispose()}function k(e){e.playback!=null&&i.playbackInfo(e),e.applications!=null&&e.applications.length!=0&&i.showSelector(e.applications);if(e.event!=null&&!i.cfg.recordingPlayback){e.event=="shutDownNotification"?(i.showDialog(i.stoppedDialog),i.disconnect()):e.event=="applicationAlreadyRunning"?i.showDialog(i.applicationAlreadyRunning):e.event=="tooManyClientsNotification"?i.showDialog(i.tooManyClientsNotification):e.event=="continueOldSession"?(i.cfg.canPaint=!1,i.showDialog(i.continueOldSessionDialog)):e.event=="continueOldSessionAutomatic"?m():e.event=="sessionStolenNotification"&&(i.cfg.canPaint=!1,i.showDialog(i.sessionStolenNotification));return}e.jsRequest!=null&&i.cfg.mirrorMode==0&&!i.cfg.recordingPlayback&&i.processJsLink(e.jsRequest),i.cfg.canPaint&&L(e)}function L(e){f.push(e),a||A()}function A(){a=null;if(f.length>0){a=f.shift();try{O(i.getCanvas(),a)}catch(e){throw a=null,e}}}function O(e,t){i.hideDialog();var n=e.getContext("2d");t.linkAction!=null&&!i.cfg.recordingPlayback&&(t.linkAction.action=="url"?i.openLink(t.linkAction.src):t.linkAction.action=="print"?i.print(encodeURIComponent(location.pathname+"file?id="+t.linkAction.src)):t.linkAction.action=="file"&&i.download("file?id="+t.linkAction.src)),t.moveAction!=null&&B(t.moveAction.sx,t.moveAction.sy,t.moveAction.dx,t.moveAction.dy,t.moveAction.width,t.moveAction.height,n),t.cursorChange!=null&&i.cfg.hasControl&&!i.cfg.recordingPlayback&&(e.style.cursor=t.cursorChange.cursor),t.copyEvent!=null&&i.cfg.hasControl&&!i.cfg.recordingPlayback&&i.displayCopyBar(t.copyEvent),t.fileDialogEvent!=null&&i.cfg.hasControl&&!i.cfg.recordingPlayback&&(t.fileDialogEvent.eventType==="Open"?i.openFileDialog(t.fileDialogEvent,i.cfg.clientId):t.fileDialogEvent.eventType==="Close"&&i.closeFileDialog()),t.closedWindow!=null&&delete l[t.closedWindow];for(var r in t.windows){var s=t.windows[r];if(s.id=="BG"){(i.cfg.mirrorMode||i.cfg.recordingPlayback)&&P(e,s.width,s.height);for(var o in s.content){var u=s.content[o];u!=null&&H(s.posX+u.positionX,s.posY+u.positionY,u.width,u.height,n)}t.windows.splice(r,1);break}}t.windows!=null?t.windows.reduce(function(e,t){return e.then(function(){return M(t,n)},F)},Promise.resolve()).then(function(){S(),A()},F):A()}function M(e,t){return e.directDraw!=null?D(e,t):_(e,t)}function _(e,t){return e.content.reduce(function(r,s){return r.then(function(){return new Promise(function(r,o){if(s!=null){var u=new Image,a=function(){t.drawImage(u,e.posX+s.positionX,e.posY+s.positionY),r(),u.onload=null,u.src="",u.clearAttributes!=null&&u.clearAttributes(),u=null};u.onload=function(){i.cfg.ieVersion&&i.cfg.ieVersion<=10?window.setTimeout(a,20):a()},u.src=n.getImageString(s.base64Content)}})},F)},Promise.resolve())}function D(e,t){return new Promise(function(n,r){var i;typeof e.directDraw=="string"?i=c.draw64(e.directDraw,l[e.id]):i=c.drawBin(e.directDraw,l[e.id]),i.then(function(r){l[e.id]=r;for(var i in e.content){var s=e.content[i];s!=null&&t.drawImage(r,s.positionX,s.positionY,s.width,s.height,e.posX+s.positionX,e.posY+s.positionY,s.width,s.height)}n()},function(e){r(e)})})}function P(e,t,n){if(e.width!=t||e.height!=n){var r=e.getContext("2d").getImageData(0,0,e.width,e.height);e.width=t,e.height=n,e.getContext("2d").putImageData(r,0,0)}}function H(e,t,n,r,i){i.clearRect(e,t,n,r)}function B(e,t,n,r,i,s,o){var u=o.getImageData(e,t,i,s);o.putImageData(u,n,r)}function j(e){var t={applicationName:i.cfg.appName,clientId:i.cfg.clientId,viewId:i.cfg.viewId,sessionId:i.getSocketId(),locale:i.getLocale(),mirrored:i.cfg.mirrorMode,directDrawSupported:i.cfg.typedArraysSupported};return i.cfg.mirrorMode||(t.applet=i.cfg.applet,t.documentBase=i.cfg.documentBase,t.params=i.cfg.params,t.desktopWidth=e.offsetWidth,t.desktopHeight=e.offsetHeight),{handshake:t}}function F(e){throw a=null,e}var r=this,i;r.injects=i={cfg:"webswing.config",disconnect:"webswing.disconnect",getSocketId:"socket.uuid",getCanvas:"canvas.get",registerInput:"input.register",sendInput:"input.sendInput",disposeInput:"input.dispose",registerTouch:"touch.register",disposeTouch:"touch.dispose",getUser:"login.user",login:"login.login",getIdentity:"identity.get",disposeIdentity:"identity.dispose",getLocale:"identity.getLocale",showDialog:"dialog.show",hideDialog:"dialog.hide",startingDialog:"dialog.content.startingDialog",stoppedDialog:"dialog.content.stoppedDialog",applicationAlreadyRunning:"dialog.content.applicationAlreadyRunning",sessionStolenNotification:"dialog.content.sessionStolenNotification",tooManyClientsNotification:"dialog.content.tooManyClientsNotification",continueOldSessionDialog:"dialog.content.continueOldSessionDialog",showSelector:"selector.show",openFileDialog:"files.open",closeFileDialog:"files.close",openLink:"files.link",print:"files.print",download:"files.download",displayCopyBar:"clipboard.displayCopyBar",processJsLink:"jslink.process",playbackInfo:"playback.playbackInfo"},r.provides={startApplication:h,startMirrorView:p,continueSession:m,kill:x,handshake:N,processMessage:k,dispose:C};var s,o,u,a,f=[],l={},c=new t({})}});